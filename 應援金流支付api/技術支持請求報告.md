# Oen Payment 技術支持請求報告

**日期**: 2025-09-12  
**商戶ID**: mktersalon  
**環境**: 測試環境 (Testing)  
**聯繫人**: 小汪記記 LINE Bot 開發團隊

## 🔍 問題概述

我們在整合 Oen Payment Token 綁卡功能時遇到測試環境的系統性問題。**後端 API 整合完全正常**，但**前端綁卡頁面無法正常運作**，導致用戶無法完成信用卡綁定流程。

## ✅ 確認正常運作的部分

### 1. API 整合狀態
- **Token 創建 API**: 完全正常
  - 端點: `POST https://payment-api.testing.oen.tw/checkout-token`
  - 回應狀態: `200 OK`
  - 回應代碼: `S0000` (執行成功)
  - 最新 Checkout ID: `32aP72iUTIWop371YCQfdH4oRGp`

### 2. 技術實作確認
- JWT Bearer Token 認證: ✅ 正確
- API 請求格式: ✅ 符合官方規範
- Webhook 端點: ✅ 正常運作
- 參數傳遞: ✅ 完整無誤

## ❌ 發現的系統問題

### 1. **SSL 證書配置錯誤** (關鍵問題)
```
錯誤訊息: Hostname/IP does not match certificate's altnames
問題域名: mktersalon.test.oen.tw
現有證書: 只包含 DNS:oen.tw, DNS:*.oen.tw
缺失配置: mktersalon.test.oen.tw 不在證書的 altnames 清單中
```

**影響**: 用戶瀏覽器無法正常載入綁卡頁面，導致 SSL 握手失敗。

### 2. **前端應用程式崩潰**
```javascript
// 瀏覽器 Console 錯誤
Error: Minified React error #418
Error: Minified React error #423
位置: index-CWhgvvqW.js, components-D_LHWbW_.js
```

**影響**: React 應用程式在載入時崩潰，用戶看到錯誤頁面。

### 3. **API 路由權限問題**
```
403 錯誤: core-api.oen.tw/checkout/mktersalon/token/32aP72iUTIWop371YCQfdH4oRGp
404 錯誤: core-api.oen.tw/user?d=mktersalon
```

**影響**: 前端頁面無法獲取必要的商戶和 Token 資訊。

### 4. **M002 系統錯誤**
```javascript
Error: M002
位置: checkout.subscription.create._transactionId-B9CzBYh_.js:1:4599
```

**影響**: 這是系統內部錯誤代碼，導致綁卡流程中斷。

## 🔧 需要官方協助解決的技術問題

### 1. **SSL 證書更新** (高優先級)
**問題**: `mktersalon.test.oen.tw` 域名未包含在 SSL 證書中
**需求**: 請將以下域名加入測試環境 SSL 證書的 SAN (Subject Alternative Names):
- `mktersalon.test.oen.tw`
- `*.mktersalon.test.oen.tw` (如需要)

### 2. **前端應用修復** (高優先級)
**問題**: React 應用程式在測試環境中存在 #418/#423 錯誤
**需求**: 
- 檢查測試環境前端代碼的完整性
- 修復 React 應用程式的配置錯誤
- 確保 JavaScript 檔案正確載入

### 3. **商戶權限配置** (中優先級)
**問題**: mktersalon 商戶的前端頁面訪問權限不完整
**需求**:
- 確認 `mktersalon` 商戶在測試環境的完整註冊狀態
- 檢查前端 API 路由的權限設定
- 確認用戶資料是否正確建立

### 4. **M002 錯誤解決** (中優先級)
**問題**: 系統內部錯誤代碼 M002
**需求**: 
- 提供 M002 錯誤的具體含義和觸發條件
- 檢查相關的系統組件是否正常運作
- 修復導致 M002 錯誤的根本原因

## 📊 測試資料記錄

### 測試時間軸
```
2025-09-12 12:00 - 開始測試
2025-09-12 12:15 - 發現 SSL 證書問題
2025-09-12 12:30 - 確認前端應用崩潰
2025-09-12 13:00 - 完成問題診斷分析
```

### API 調用記錄
```json
{
  "endpoint": "POST /checkout-token",
  "status": 200,
  "code": "S0000",
  "checkoutId": "32aP72iUTIWop371YCQfdH4oRGp",
  "timestamp": "2025-09-12T05:00:00.000Z"
}
```

### 綁卡頁面 URL
```
測試 URL: https://mktersalon.test.oen.tw/checkout/subscription/create/32aP72iUTIWop371YCQfdH4oRGp
錯誤狀態: SSL 證書不匹配，前端應用崩潰
```

## 🔧 Webhook 配置資訊

```json
{
  "webhookUrl": "https://a4cc9d907f15.ngrok-free.app/api/payment/token-webhook",
  "successUrl": "https://a4cc9d907f15.ngrok-free.app/payment/token-success",
  "failureUrl": "https://a4cc9d907f15.ngrok-free.app/payment/token-failure",
  "status": "測試回調正常，真實回調無法收到"
}
```

## 🎯 期望的解決方案

### 1. **立即處理** (24小時內)
- [ ] 更新 SSL 證書以包含 `mktersalon.test.oen.tw`
- [ ] 修復前端 React 應用的崩潰問題
- [ ] 確認商戶權限設定完整性

### 2. **後續改善** (1週內)
- [ ] 提供 M002 錯誤的完整說明文件
- [ ] 建立測試環境監控機制
- [ ] 提供測試商戶的完整設定指南

### 3. **預防措施**
- [ ] 建立 SSL 證書自動更新機制
- [ ] 實施測試環境健康檢查
- [ ] 提供商戶自助診斷工具

## 📞 技術聯繫資訊

**開發團隊**: 小汪記記 LINE Bot  
**測試環境**: https://a4cc9d907f15.ngrok-free.app  
**Webhook 端點**: 已設定並正常運作  
**緊急聯繫**: 如需即時協助，請回覆此郵件

## 📋 確認清單

請協助確認以下項目的處理狀態：

- [ ] **SSL 證書更新**: mktersalon.test.oen.tw 域名已加入
- [ ] **前端修復**: React 錯誤 #418/#423 已解決
- [ ] **權限設定**: mktersalon 商戶前端權限已配置
- [ ] **API 路由**: 403/404 錯誤已修復
- [ ] **M002 錯誤**: 系統錯誤已解決
- [ ] **測試確認**: 綁卡流程端到端測試成功

---

**感謝您的協助！我們期待您的回覆和解決方案。**

*此報告包含完整的技術診斷資料，如需更多資訊或日誌檔案，請隨時告知。*