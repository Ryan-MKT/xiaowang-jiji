# 開發與生產環境工作流程指南

## 🏗️ 環境架構總覽

```
測試環境（開發用）                生產環境（使用者用）
    ↓                              ↓
測試 Bot                        正式 Bot
本機 + ngrok                    Zeabur 部署
develop 分支                    master 分支
.env.development               .env.production
```

## 📱 步驟 0：初始設定（只需做一次）

### 1. 建立測試 Bot
- 到 LINE Developers Console 建立新的 Messaging API Channel
- 命名：`小汪記記-測試版`
- 取得測試 Bot 的 Channel Secret 和 Access Token

### 2. 設定環境變數檔案
編輯 `.env.development`，填入測試 Bot 資訊：
```bash
LINE_CHANNEL_ACCESS_TOKEN=測試Bot的Token
LINE_CHANNEL_SECRET=測試Bot的Secret
```

編輯 `.env.production`，填入正式 Bot 資訊：
```bash
LINE_CHANNEL_ACCESS_TOKEN=正式Bot的Token
LINE_CHANNEL_SECRET=正式Bot的Secret
```

### 3. 安裝 ngrok
- 下載：https://ngrok.com/download
- 解壓縮後放到系統路徑或專案目錄

## 🔄 日常開發工作流程

### 📝 開發新功能時

#### 1. 切換到開發環境
```bash
# 切換到開發分支
git checkout develop

# 切換環境變數到開發模式
npm run env:dev

# 或一次完成（切換環境並啟動）
npm run switch:dev
```

#### 2. 啟動本機伺服器
```bash
# 在第一個終端機
npm run dev
# 伺服器會在 http://localhost:3000 啟動
```

#### 3. 建立公開網址（ngrok）
```bash
# 在第二個終端機
ngrok http 3000

# 會顯示類似：
# Forwarding https://abc123.ngrok.io -> http://localhost:3000
```

#### 4. 更新測試 Bot 的 Webhook
- 到 LINE Developers Console
- 選擇測試 Bot
- Messaging API 設定
- Webhook URL: `https://abc123.ngrok.io/webhook`
- 開啟 Use webhook

#### 5. 測試功能
- 在 LINE 加測試 Bot 為好友
- 測試新功能
- 修改程式碼會立即生效（重啟 server）

### 🚀 部署到生產環境

#### 1. 確認功能完成
```bash
# 在開發分支提交變更
git add .
git commit -m "feat: 新增記帳統計功能"
```

#### 2. 切換到主分支
```bash
# 切換到 master 分支
git checkout master

# 合併開發分支
git merge develop
```

#### 3. 推送到 GitHub
```bash
git push origin master

# Zeabur 會自動部署（約 1-2 分鐘）
```

#### 4. 驗證生產環境
- 使用正式 Bot 測試
- 確認功能正常運作

## 📊 環境切換快速指令

| 指令 | 說明 |
|------|------|
| `npm run env:dev` | 切換到開發環境設定 |
| `npm run env:prod` | 切換到生產環境設定 |
| `npm run switch:dev` | 切換到開發環境並啟動 |
| `npm run switch:prod` | 切換到生產環境 |

## 🔍 如何確認當前環境

### 檢查當前 Git 分支
```bash
git branch
# * develop  ← 開發環境
#   master   ← 生產環境
```

### 檢查環境變數
```bash
# 查看當前使用的 Bot
cat .env | grep CHANNEL_ACCESS_TOKEN
```

## ⚠️ 重要注意事項

### 開發環境
- ✅ 可以隨意測試，不影響使用者
- ✅ 程式碼錯誤只影響你自己
- ⚠️ ngrok 網址每次重啟會改變
- ⚠️ 記得更新 Webhook URL

### 生產環境
- ⚠️ 推送前必須充分測試
- ⚠️ 不要直接在 master 分支開發
- ⚠️ 確保環境變數使用正式 Bot
- ✅ Zeabur 自動部署，無需手動

## 🆘 常見問題

### Q: ngrok 網址過期了怎麼辦？
A: 重新執行 `ngrok http 3000`，並更新測試 Bot 的 Webhook URL

### Q: 不小心把測試 token 推到生產怎麼辦？
A: 立即在 Zeabur 更新環境變數，使用正確的生產 token

### Q: 如何回復到之前的版本？
A: 使用 `git revert` 或 `git reset`，然後重新推送

### Q: 測試 Bot 和正式 Bot 功能不同步？
A: 確認已將 develop 分支合併到 master 並推送

## 📋 部署前檢查清單

- [ ] 功能在測試 Bot 運作正常
- [ ] 沒有 console.log 除錯訊息
- [ ] 環境變數切換到生產模式
- [ ] 程式碼已 commit
- [ ] 準備合併到 master 分支

## 🎯 最佳實踐

1. **永遠在 develop 分支開發**
2. **使用測試 Bot 進行所有測試**
3. **確認無誤才合併到 master**
4. **保持兩個 Bot 完全獨立**
5. **定期備份環境設定檔**