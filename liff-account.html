<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小汪記記 - 帳戶設定</title>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: none;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 20px;
        }
        
        .account-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 16px rgba(31, 38, 135, 0.2);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .error {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 標題卡片 -->
        <div class="card header-card">
            <div class="card-body text-center py-4">
                <h1 class="h3 mb-2 text-primary">👤 帳戶設定</h1>
                <p class="text-muted mb-0">個人資料與設定管理</p>
            </div>
        </div>

        <!-- 載入中顯示 -->
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
        </div>

        <!-- 錯誤訊息 -->
        <div id="error" class="error" style="display: none;"></div>

        <!-- 帳戶資訊卡片 -->
        <div id="accountContent" class="card account-card" style="display: none;">
            <div class="card-body p-4">
                <!-- 使用者資料 -->
                <div class="text-center mb-4">
                    <img id="userAvatar" src="" alt="大頭照" class="profile-avatar mb-3">
                    <h4 id="userName" class="text-dark mb-1">--</h4>
                    <p id="userStatus" class="text-muted mb-0">--</p>
                </div>

                <!-- 詳細資訊 -->
                <div class="row g-3">
                    <div class="col-12">
                        <div class="info-item p-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-badge text-primary me-3 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark">使用者 ID</div>
                                    <div id="userId" class="text-muted small">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="info-item p-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope text-primary me-3 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark">電子郵件</div>
                                    <div id="userEmail" class="text-muted small">未設定</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="info-item p-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-star text-warning me-3 fs-5"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-dark">會員狀態</div>
                                    <div id="subscriptionStatus" class="text-muted small">載入中...</div>
                                </div>
                                <div id="subscriptionBadge" class="badge bg-secondary">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="info-item p-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar-check text-primary me-3 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark">加入時間</div>
                                    <div id="joinDate" class="text-muted small">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 功能按鈕 -->
                <div class="mt-4 pt-3 border-top">
                    <div class="row g-2 mb-2">
                        <div class="col-12">
                            <button class="btn btn-warning w-100" onclick="upgradeSubscription()">
                                <i class="bi bi-star me-2"></i>訂閱升級
                            </button>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100" onclick="closeApp()">
                                <i class="bi bi-arrow-left me-2"></i>返回
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-primary w-100" onclick="refreshProfile()">
                                <i class="bi bi-arrow-clockwise me-2"></i>重新整理
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let liffProfile = null;

        // LIFF 初始化
        async function initializeLiff() {
            try {
                console.log('🔧 [LIFF 初始化] 開始初始化 LIFF...');
                
                await liff.init({
                    liffId: '2008077335-rZlgE4bX'
                });
                
                console.log('✅ [LIFF 初始化] LIFF 初始化成功');
                
                if (liff.isLoggedIn()) {
                    console.log('✅ [使用者驗證] 使用者已登入');
                    await loadUserProfile();
                } else {
                    console.log('❌ [使用者驗證] 使用者未登入，導向登入頁面');
                    liff.login();
                }
            } catch (error) {
                console.error('❌ [LIFF 初始化] 初始化失敗:', error);
                showError('LIFF 初始化失敗: ' + error.message);
            }
        }

        // 載入使用者資料
        async function loadUserProfile() {
            try {
                console.log('👤 [使用者資料] 開始載入使用者資料...');
                
                liffProfile = await liff.getProfile();
                console.log('✅ [使用者資料] 使用者資料載入成功:', liffProfile);
                
                displayUserProfile();
                await loadSubscriptionStatus();
                
            } catch (error) {
                console.error('❌ [使用者資料] 載入失敗:', error);
                showError('載入使用者資料失敗: ' + error.message);
            }
        }

        // 顯示使用者資料
        function displayUserProfile() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('accountContent').style.display = 'block';
            
            // 填入使用者資料
            document.getElementById('userAvatar').src = liffProfile.pictureUrl || 'https://via.placeholder.com/80?text=👤';
            document.getElementById('userName').textContent = liffProfile.displayName || '未設定';
            document.getElementById('userStatus').textContent = liffProfile.statusMessage || '沒有狀態訊息';
            document.getElementById('userId').textContent = liffProfile.userId;
            
            // 設定加入時間（模擬）
            document.getElementById('joinDate').textContent = new Date().toLocaleDateString('zh-TW');
        }

        // 重新整理資料
        async function refreshProfile() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('accountContent').style.display = 'none';
            await loadUserProfile();
        }

        // 顯示錯誤訊息
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // 關閉應用程式
        function closeApp() {
            liff.closeWindow();
        }

        // 載入訂閱狀態
        async function loadSubscriptionStatus() {
            try {
                console.log('💳 [訂閱狀態] 開始載入訂閱狀態...');
                
                const response = await fetch('/api/subscription/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: liffProfile.userId
                    })
                });
                
                if (response.ok) {
                    const subscription = await response.json();
                    console.log('✅ [訂閱狀態] 訂閱狀態載入成功:', subscription);
                    displaySubscriptionStatus(subscription);
                } else {
                    console.error('❌ [訂閱狀態] 載入失敗:', response.status);
                    displaySubscriptionStatus(null);
                }
                
            } catch (error) {
                console.error('❌ [訂閱狀態] 載入錯誤:', error);
                displaySubscriptionStatus(null);
            }
        }

        // 顯示訂閱狀態
        function displaySubscriptionStatus(subscription) {
            const statusElement = document.getElementById('subscriptionStatus');
            const badgeElement = document.getElementById('subscriptionBadge');
            const upgradeButton = document.querySelector('.btn-warning');
            
            if (subscription && subscription.subscription_type === 'premium' && subscription.status === 'active') {
                // Premium 會員
                const expiryDate = new Date(subscription.expires_at);
                const expiryDateStr = expiryDate.toLocaleDateString('zh-TW');
                
                statusElement.textContent = `Premium 會員，有效期至 ${expiryDateStr}`;
                badgeElement.textContent = 'Premium';
                badgeElement.className = 'badge bg-warning';
                
                // 更新按鈕為續約
                upgradeButton.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>續約 Premium';
                upgradeButton.className = 'btn btn-outline-warning w-100';
                
                console.log('✨ [訂閱狀態] 顯示 Premium 會員狀態');
                
            } else {
                // 免費會員
                statusElement.textContent = '免費會員，立即升級享受進階功能';
                badgeElement.textContent = '免費';
                badgeElement.className = 'badge bg-secondary';
                
                // 保持原來的升級按鈕
                upgradeButton.innerHTML = '<i class="bi bi-star me-2"></i>訂閱升級';
                upgradeButton.className = 'btn btn-warning w-100';
                
                console.log('📄 [訂閱狀態] 顯示免費會員狀態');
            }
        }

        // 訂閱升級功能
        async function upgradeSubscription() {
            try {
                console.log('💳 [訂閱升級] 開始升級流程...');
                
                if (!liffProfile) {
                    alert('請先重新整理頁面載入用戶資料');
                    return;
                }
                
                // 顯示載入狀態
                const button = document.querySelector('.btn-warning');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>處理中...';
                button.disabled = true;
                
                // 調用後端 API 創建支付訂單
                const response = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: liffProfile.userId,
                        userName: liffProfile.displayName,
                        amount: 299, // 訂閱升級價格 299 元
                        itemName: '小汪記記 - 進階功能訂閱',
                        description: '解鎖進階功能：無限制任務數量、智能分類、優先客服支援'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ [訂閱升級] 訂單建立成功:', result.orderId);
                    
                    // 開啟支付頁面
                    window.open(result.paymentUrl, '_blank', 'width=600,height=800');
                    
                    // 恢復按鈕狀態
                    button.innerHTML = originalText;
                    button.disabled = false;
                    
                    alert('💳 支付頁面已開啟，請完成付款！\n完成後您即可享受進階功能。');
                    
                } else {
                    console.error('❌ [訂閱升級] 建立訂單失敗:', result.error);
                    alert('❌ 建立訂單失敗：' + result.error + '\n請稍後再試。');
                    
                    // 恢復按鈕狀態
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
                
            } catch (error) {
                console.error('❌ [訂閱升級] 升級流程失敗:', error);
                alert('❌ 升級失敗，請檢查網路連線後重試。');
                
                // 恢復按鈕狀態
                const button = document.querySelector('.btn-warning');
                button.innerHTML = '<i class="bi bi-star me-2"></i>訂閱升級';
                button.disabled = false;
            }
        }

        // 頁面載入時初始化 LIFF
        window.addEventListener('load', initializeLiff);
    </script>
</body>
</html>