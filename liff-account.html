<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ±ªè¨˜è¨˜ - å¸³æˆ¶è¨­å®š</title>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: none;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 20px;
        }
        
        .account-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 16px rgba(31, 38, 135, 0.2);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .error {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œå¡ç‰‡ -->
        <div class="card header-card">
            <div class="card-body text-center py-4">
                <h1 class="h3 mb-2 text-primary">ğŸ‘¤ å¸³æˆ¶è¨­å®š</h1>
                <p class="text-muted mb-0">å€‹äººè³‡æ–™èˆ‡è¨­å®šç®¡ç†</p>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­é¡¯ç¤º -->
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
            </div>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="error" class="error" style="display: none;"></div>

        <!-- å¸³æˆ¶è³‡è¨Šå¡ç‰‡ -->
        <div id="accountContent" class="card account-card" style="display: none;">
            <div class="card-body p-4">
                <!-- ä½¿ç”¨è€…è³‡æ–™ -->
                <div class="text-center mb-4">
                    <img id="userAvatar" src="" alt="å¤§é ­ç…§" class="profile-avatar mb-3">
                    <h4 id="userName" class="text-dark mb-1">--</h4>
                    <p id="userStatus" class="text-muted mb-0">--</p>
                </div>

                <!-- è©³ç´°è³‡è¨Š -->
                <div class="row g-3">
                    <div class="col-12">
                        <div class="info-item p-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-badge text-primary me-3 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark">ä½¿ç”¨è€… ID</div>
                                    <div id="userId" class="text-muted small">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="info-item p-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope text-primary me-3 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark">é›»å­éƒµä»¶</div>
                                    <div id="userEmail" class="text-muted small">æœªè¨­å®š</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="info-item p-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-star text-warning me-3 fs-5"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-dark">æœƒå“¡ç‹€æ…‹</div>
                                    <div id="subscriptionStatus" class="text-muted small">è¼‰å…¥ä¸­...</div>
                                </div>
                                <div id="subscriptionBadge" class="badge bg-secondary">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="info-item p-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar-check text-primary me-3 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark">åŠ å…¥æ™‚é–“</div>
                                    <div id="joinDate" class="text-muted small">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŠŸèƒ½æŒ‰éˆ• -->
                <div class="mt-4 pt-3 border-top">
                    <div class="row g-2 mb-2">
                        <div class="col-12">
                            <button class="btn btn-warning w-100" onclick="upgradeSubscription()">
                                <i class="bi bi-star me-2"></i>è¨‚é–±å‡ç´š
                            </button>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100" onclick="closeApp()">
                                <i class="bi bi-arrow-left me-2"></i>è¿”å›
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-primary w-100" onclick="refreshProfile()">
                                <i class="bi bi-arrow-clockwise me-2"></i>é‡æ–°æ•´ç†
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let liffProfile = null;

        // LIFF åˆå§‹åŒ–
        async function initializeLiff() {
            try {
                console.log('ğŸ”§ [LIFF åˆå§‹åŒ–] é–‹å§‹åˆå§‹åŒ– LIFF...');
                
                await liff.init({
                    liffId: '2008077335-rZlgE4bX'
                });
                
                console.log('âœ… [LIFF åˆå§‹åŒ–] LIFF åˆå§‹åŒ–æˆåŠŸ');
                
                if (liff.isLoggedIn()) {
                    console.log('âœ… [ä½¿ç”¨è€…é©—è­‰] ä½¿ç”¨è€…å·²ç™»å…¥');
                    await loadUserProfile();
                } else {
                    console.log('âŒ [ä½¿ç”¨è€…é©—è­‰] ä½¿ç”¨è€…æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                    liff.login();
                }
            } catch (error) {
                console.error('âŒ [LIFF åˆå§‹åŒ–] åˆå§‹åŒ–å¤±æ•—:', error);
                showError('LIFF åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }

        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
        async function loadUserProfile() {
            try {
                console.log('ğŸ‘¤ [ä½¿ç”¨è€…è³‡æ–™] é–‹å§‹è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™...');
                
                liffProfile = await liff.getProfile();
                console.log('âœ… [ä½¿ç”¨è€…è³‡æ–™] ä½¿ç”¨è€…è³‡æ–™è¼‰å…¥æˆåŠŸ:', liffProfile);
                
                displayUserProfile();
                await loadSubscriptionStatus();
                
            } catch (error) {
                console.error('âŒ [ä½¿ç”¨è€…è³‡æ–™] è¼‰å…¥å¤±æ•—:', error);
                showError('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—: ' + error.message);
            }
        }

        // é¡¯ç¤ºä½¿ç”¨è€…è³‡æ–™
        function displayUserProfile() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('accountContent').style.display = 'block';
            
            // å¡«å…¥ä½¿ç”¨è€…è³‡æ–™
            document.getElementById('userAvatar').src = liffProfile.pictureUrl || 'https://via.placeholder.com/80?text=ğŸ‘¤';
            document.getElementById('userName').textContent = liffProfile.displayName || 'æœªè¨­å®š';
            document.getElementById('userStatus').textContent = liffProfile.statusMessage || 'æ²’æœ‰ç‹€æ…‹è¨Šæ¯';
            document.getElementById('userId').textContent = liffProfile.userId;
            
            // è¨­å®šåŠ å…¥æ™‚é–“ï¼ˆæ¨¡æ“¬ï¼‰
            document.getElementById('joinDate').textContent = new Date().toLocaleDateString('zh-TW');
        }

        // é‡æ–°æ•´ç†è³‡æ–™
        async function refreshProfile() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('accountContent').style.display = 'none';
            await loadUserProfile();
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // é—œé–‰æ‡‰ç”¨ç¨‹å¼
        function closeApp() {
            liff.closeWindow();
        }

        // è¼‰å…¥è¨‚é–±ç‹€æ…‹
        async function loadSubscriptionStatus() {
            try {
                console.log('ğŸ’³ [è¨‚é–±ç‹€æ…‹] é–‹å§‹è¼‰å…¥è¨‚é–±ç‹€æ…‹...');
                
                const response = await fetch('/api/subscription/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: liffProfile.userId
                    })
                });
                
                if (response.ok) {
                    const subscription = await response.json();
                    console.log('âœ… [è¨‚é–±ç‹€æ…‹] è¨‚é–±ç‹€æ…‹è¼‰å…¥æˆåŠŸ:', subscription);
                    displaySubscriptionStatus(subscription);
                } else {
                    console.error('âŒ [è¨‚é–±ç‹€æ…‹] è¼‰å…¥å¤±æ•—:', response.status);
                    displaySubscriptionStatus(null);
                }
                
            } catch (error) {
                console.error('âŒ [è¨‚é–±ç‹€æ…‹] è¼‰å…¥éŒ¯èª¤:', error);
                displaySubscriptionStatus(null);
            }
        }

        // é¡¯ç¤ºè¨‚é–±ç‹€æ…‹
        function displaySubscriptionStatus(subscription) {
            const statusElement = document.getElementById('subscriptionStatus');
            const badgeElement = document.getElementById('subscriptionBadge');
            const upgradeButton = document.querySelector('.btn-warning');
            
            if (subscription && subscription.subscription_type === 'premium' && subscription.status === 'active') {
                // Premium æœƒå“¡
                const expiryDate = new Date(subscription.expires_at);
                const expiryDateStr = expiryDate.toLocaleDateString('zh-TW');
                
                statusElement.textContent = `Premium æœƒå“¡ï¼Œæœ‰æ•ˆæœŸè‡³ ${expiryDateStr}`;
                badgeElement.textContent = 'Premium';
                badgeElement.className = 'badge bg-warning';
                
                // æ›´æ–°æŒ‰éˆ•ç‚ºçºŒç´„
                upgradeButton.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>çºŒç´„ Premium';
                upgradeButton.className = 'btn btn-outline-warning w-100';
                
                console.log('âœ¨ [è¨‚é–±ç‹€æ…‹] é¡¯ç¤º Premium æœƒå“¡ç‹€æ…‹');
                
            } else {
                // å…è²»æœƒå“¡
                statusElement.textContent = 'å…è²»æœƒå“¡ï¼Œç«‹å³å‡ç´šäº«å—é€²éšåŠŸèƒ½';
                badgeElement.textContent = 'å…è²»';
                badgeElement.className = 'badge bg-secondary';
                
                // ä¿æŒåŸä¾†çš„å‡ç´šæŒ‰éˆ•
                upgradeButton.innerHTML = '<i class="bi bi-star me-2"></i>è¨‚é–±å‡ç´š';
                upgradeButton.className = 'btn btn-warning w-100';
                
                console.log('ğŸ“„ [è¨‚é–±ç‹€æ…‹] é¡¯ç¤ºå…è²»æœƒå“¡ç‹€æ…‹');
            }
        }

        // è¨‚é–±å‡ç´šåŠŸèƒ½
        async function upgradeSubscription() {
            try {
                console.log('ğŸ’³ [è¨‚é–±å‡ç´š] é–‹å§‹å‡ç´šæµç¨‹...');
                
                if (!liffProfile) {
                    alert('è«‹å…ˆé‡æ–°æ•´ç†é é¢è¼‰å…¥ç”¨æˆ¶è³‡æ–™');
                    return;
                }
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const button = document.querySelector('.btn-warning');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>è™•ç†ä¸­...';
                button.disabled = true;
                
                // èª¿ç”¨å¾Œç«¯ API å‰µå»ºæ”¯ä»˜è¨‚å–®
                const response = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: liffProfile.userId,
                        userName: liffProfile.displayName,
                        amount: 299, // è¨‚é–±å‡ç´šåƒ¹æ ¼ 299 å…ƒ
                        itemName: 'å°æ±ªè¨˜è¨˜ - é€²éšåŠŸèƒ½è¨‚é–±',
                        description: 'è§£é–é€²éšåŠŸèƒ½ï¼šç„¡é™åˆ¶ä»»å‹™æ•¸é‡ã€æ™ºèƒ½åˆ†é¡ã€å„ªå…ˆå®¢æœæ”¯æ´'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… [è¨‚é–±å‡ç´š] è¨‚å–®å»ºç«‹æˆåŠŸ:', result.orderId);
                    
                    // é–‹å•Ÿæ”¯ä»˜é é¢
                    window.open(result.paymentUrl, '_blank', 'width=600,height=800');
                    
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    button.innerHTML = originalText;
                    button.disabled = false;
                    
                    alert('ğŸ’³ æ”¯ä»˜é é¢å·²é–‹å•Ÿï¼Œè«‹å®Œæˆä»˜æ¬¾ï¼\nå®Œæˆå¾Œæ‚¨å³å¯äº«å—é€²éšåŠŸèƒ½ã€‚');
                    
                } else {
                    console.error('âŒ [è¨‚é–±å‡ç´š] å»ºç«‹è¨‚å–®å¤±æ•—:', result.error);
                    alert('âŒ å»ºç«‹è¨‚å–®å¤±æ•—ï¼š' + result.error + '\nè«‹ç¨å¾Œå†è©¦ã€‚');
                    
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
                
            } catch (error) {
                console.error('âŒ [è¨‚é–±å‡ç´š] å‡ç´šæµç¨‹å¤±æ•—:', error);
                alert('âŒ å‡ç´šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦ã€‚');
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                const button = document.querySelector('.btn-warning');
                button.innerHTML = '<i class="bi bi-star me-2"></i>è¨‚é–±å‡ç´š';
                button.disabled = false;
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ– LIFF
        window.addEventListener('load', initializeLiff);
    </script>
</body>
</html>